# Modern.js

This plugin provides Module Federation supporting functions for Modern.js

## Supports

- modern.js ^2.52.0
- Server-Side Rendering

We highly recommend referencing this application which takes advantage of the best capabilities:
[module-federation example](https://github.com/module-federation/core/tree/feat/modernjs-ssr/apps/modernjs-ssr)

## Quick Start

### Installation

You can install the plugin with the following commands:

import { PackageManagerTabs } from '@theme';

<PackageManagerTabs
  command={{
    npm: 'npm add @module-federation/modern-js --save',
    yarn: 'yarn add @module-federation/modern-js --save',
    pnpm: 'pnpm add @module-federation/modern-js --save',
    bun: 'bun add @module-federation/modern-js --save',
  }}
/>

### Apply Plugin

Apply this plugin in `plugins` of `modern.config.ts`:

```ts title="modern.config.ts"
import { appTools, defineConfig } from '@modern-js/app-tools';
import { moduleFederationPlugin } from '@module-federation/modern-js';

export default defineConfig({
  dev: {
    port: 3005,
  },
  runtime: {
    router: true,
  },
  server: {
    ssr: {
      mode: 'stream',
    },
  },
  plugins: [appTools(), moduleFederationPlugin()],
});
```

Then create the `module-federation.config.ts` file and write the required configuration:

```ts title="module-federation.config.ts"
import { createModuleFederationConfig } from '@module-federation/modern-js';
export default createModuleFederationConfig({
  name: 'host',
  remotes: {
    remote: 'remote@http://localhost:3006/mf-manifest.json',
  },
  shared: {
    react: { singleton: true },
    'react-dom': { singleton: true },
  },
});
```

## Server-Side Rendering

:::info
For a better performance experience, Module Federation X Modern.js SSR only supports stream SSR.
:::

There is no difference between using Module Federation in SSR scenarios and CSR scenarios. Developers can just keep following the original development behavior.

But for a better development experience, we provide corresponding components to help developers better use Module Federation.

### MFReactComponent

import Collapse from '@components/Collapse'

<Collapse>
```ts
declare function MFReactComponent(
  props: MFReactComponentProps
): React.ReactElement;

type Id = string;
type MFReactComponentProps =
  | {
      id: Id;
      injectScript?: boolean;
      injectLink?: boolean;
      loading?: React.ReactNode;
      fallback?:
        | ((err: Error) => React.FC | React.ReactElement)
        | React.FC
        | React.ReactElement;
    }
  | Id;
```
</Collapse>

While loading the component, this component will also help inject the corresponding link/script. This behavior can help avoid the CSS flickering problem caused by streaming rendering and accelerate the PID (first screen interactive time).

#### Example

```tsx
import React, { FC, memo, useEffect } from 'react';
import { registerRemotes, MFReactComponent } from '@modern-js/runtime/mf';

const Product: FC = () => {
  registerRemotes([
    {
      name: 'dynamic_remote',
      entry: 'http://localhost:3008/mf-manifest.json',
    },
  ]);

  const fallback = (err: Error) => {
    if (err.message.includes('does not exist in container')) {
      return <div>404</div>;
    }
    throw err;
  };

  return <>
    <MFReactComponent id={rId} fallback={fallback} />
  </>;
};
export default Product;
```

#### id

- Type:`string`
- Required: Yes
- Default value: `undefined`

The complete request path. After setting, `loadRemote` will be called to load this module.

#### loading

- Type:`React.ReactNode`
- Required: No
- Default value: `undefined`

Set module loading status.

#### fallback

- Type:`((err: Error) => React.FC | React.ReactElement) | React.FC | React.ReactElement`
- Required: No
- Default value: `undefined`

Loading failure tolerant components.

#### injectLink

- Type:`boolean`
- Required: No
- Default value: `true`

Whether to inject the style of the corresponding component.

#### injectScript

- Type:`boolean`
- Required: No
- Default value: `true`

Whether to inject the script of the corresponding component.

### LiveReload

:::info
This component will not take effect in the production environment!
:::

<Collapse>
```ts
declare function LiveReload(): React.JSX.Element | null;
```
</Collapse>

When remote components are updated, page reloads occur automatically.

#### Example

```tsx
import { Outlet } from '@modern-js/runtime/router';
import { LiveReload } from '@modern-js/runtime/mf';

export default function Layout() {
  return (
    <div>
      <LiveReload />
      <Outlet />
    </div>
  );
}
```
